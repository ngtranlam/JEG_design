name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            executable_name: JEGDesignExtract.exe
            upscayl_binary: upscayl-ncnn.exe
          - os: macos-latest
            platform: macos
            executable_name: JEGDesignExtract
            upscayl_binary: upscayl-ncnn

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Verify resources exist
      run: |
        if [ "${{ matrix.platform }}" == "windows" ]; then
          if [ ! -f "upscayl_core/bin/upscayl-ncnn.exe" ]; then
            echo "Windows binary not found!"
            exit 1
          fi
          echo "Windows binary found"
        else
          if [ ! -f "upscayl_core/bin/upscayl-ncnn" ]; then
            echo "macOS binary not found!"
            exit 1
          fi
          echo "macOS binary found"
        fi
        
        # Verify logo and icon files exist
        if [ ! -f "jeglogo.png" ]; then
          echo "Logo file not found!"
          exit 1
        fi
        echo "Logo file found"
        
        if [ "${{ matrix.platform }}" == "windows" ]; then
          if [ ! -f "app_icon.ico" ] && [ ! -f "app.ico" ]; then
            echo "No ICO icon file found for Windows!"
            exit 1
          fi
          echo "ICO icon file found for Windows"
        else
          if [ ! -f "app_icon.png" ] && [ ! -f "app.icns" ]; then
            echo "No icon file found for macOS!"
            exit 1
          fi
          echo "Icon file found for macOS"
        fi
      shell: bash

    - name: Build executable
      run: |
        if [ "${{ matrix.platform }}" == "windows" ]; then
          # Use optimized spec file for Windows
          pyinstaller windows_build.spec --clean --noconfirm --distpath=dist-release
        else
          # Use command line for macOS
          pyinstaller --onefile \
            --windowed \
            --name=JEGDesignExtract \
            --icon=app_icon.png \
            --add-data="jeglogo.png:." \
            --add-data="upscayl_core:upscayl_core" \
            --add-data="api_client.py:." \
            --add-data="upscayl_processor.py:." \
            --hidden-import=cv2.cv2 \
            --hidden-import=numpy.core.multiarray \
            --hidden-import=PIL._tkinter_finder \
            --distpath=dist-release \
            --clean \
            --noconfirm \
            jeg_design_extract.py
        fi
      shell: bash

    - name: Verify build output
      run: |
        if [ ! -f "dist-release/${{ matrix.executable_name }}" ]; then
          echo "Build failed - executable not found"
          echo "Contents of dist-release directory:"
          ls -la dist-release/ || echo "Dist directory not found"
          exit 1
        fi
        echo "Build successful!"
        echo "Executable: $(ls -la dist-release/${{ matrix.executable_name }})"
        echo "Size: $(du -h dist-release/${{ matrix.executable_name }} | cut -f1)"
      shell: bash

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: JEGDesignExtract-${{ matrix.platform }}-${{ github.ref_name }}
        path: |
          dist-release/${{ matrix.executable_name }}
        retention-days: 90

    - name: Create Release
      if: matrix.platform == 'windows' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: JEG Design Extract ${{ github.ref_name }}
        body: |
          ## JEG Design Extract ${{ github.ref_name }}
          
          ### What's New
          - Updated logo to use `jeglogo.png`
          - Fixed read-only file system issues for PyInstaller builds
          - Improved cache management for better performance
          - Updated to version 2.2.0
          
          ### Downloads
          - **Windows**: Download the `.exe` file from the artifacts
          - **macOS**: Download the executable from the artifacts
          
          ### Installation
          1. Download the appropriate file for your platform
          2. Run the executable
          3. The app will create cache directories in your user folder
          
          ### Features
          - Extract design from images using AI
          - Upscale images with AI models
          - Modern dark theme UI
          - Cross-platform support
        files: |
          dist-release/${{ matrix.executable_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
